import{_ as l,r as p,o as i,c as u,a as s,b as n,d as a,w as c,e}from"./app.8f1211c8.js";const r="/assets/context-beginwork.bff2391e.png",k="/assets/context-completework.c022d9a5.png",d={},v=e('<h1 id="react-中的栈操作" tabindex="-1"><a class="header-anchor" href="#react-中的栈操作" aria-hidden="true">#</a> React 中的栈操作</h1><h2 id="概念" tabindex="-1"><a class="header-anchor" href="#概念" aria-hidden="true">#</a> 概念</h2><p>来自 wiki 上的解释: <code>堆栈</code>(<code>stack</code>)又称为<code>栈</code>或<code>堆叠</code>, 是计算机科学中的一种抽象资料类型, 只允许在有序的线性资料集合的一端(称为堆栈顶端<code>top</code>)进行加入数据(<code>push</code>)和移除数据(<code>pop</code>)的运算. 因而按照后进先出(<code>LIFO, Last In First Out</code>)的原理运作.</p><p>注意:</p>',4),m=e("<li><code>栈</code>(stack)又叫做<code>堆栈</code>, 这里特指数据结构中的<code>栈</code>(另一种<code>程序内存分配</code>中的栈, 本系列不做介绍, 读者可自行了解).</li><li><code>堆栈</code>中虽带有一个<code>堆</code>字, 只是命名, 不要和<code>堆</code>混淆.</li>",2),b=s("code",null,"堆",-1),h=s("code",null,"数据结构",-1),x=s("code",null,"程序内存分配",-1),g=e(`<h2 id="特性" tabindex="-1"><a class="header-anchor" href="#特性" aria-hidden="true">#</a> 特性</h2><ol><li>先入后出, 后入先出.</li><li>除头尾节点之外, 每个元素有一个前驱, 一个后继.</li></ol><h2 id="基本使用" tabindex="-1"><a class="header-anchor" href="#基本使用" aria-hidden="true">#</a> 基本使用</h2><ol><li>压栈: <code>push()</code></li><li>弹栈: <code>pop((</code></li><li>预览栈顶元素: <code>peek()</code></li></ol><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">Stack</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dataStore <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>top <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 压栈</span>
  <span class="token function">push</span><span class="token punctuation">(</span><span class="token parameter">element</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dataStore<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>top<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> element<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 弹栈</span>
  <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dataStore<span class="token punctuation">[</span><span class="token operator">--</span><span class="token keyword">this</span><span class="token punctuation">.</span>top<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 预览栈顶元素</span>
  <span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dataStore<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>top <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 检测栈内存储了多少个元素</span>
  <span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>top<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 清空栈</span>
  <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>top <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>测试代码:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token function-variable function">test</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> stack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;压栈a: &#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;a&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;压栈b: &#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;b&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;压栈c: &#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;c&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;栈高度: &#39;</span><span class="token punctuation">,</span> stack<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;栈顶元素: &#39;</span><span class="token punctuation">,</span> stack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;弹出: &#39;</span><span class="token punctuation">,</span> stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;栈顶元素: &#39;</span><span class="token punctuation">,</span> stack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;压栈d: &#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;d&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;栈顶元素: &#39;</span><span class="token punctuation">,</span> stack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;清空栈: &#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  stack<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;栈高度: &#39;</span><span class="token punctuation">,</span> stack<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;压栈e: &#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&#39;e&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;栈顶元素: &#39;</span><span class="token punctuation">,</span> stack<span class="token punctuation">.</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>利用栈先进后出的特性, 在实际编码中应用非常广泛. 如<code>回溯</code>,<code>递归</code>,<code>深度优先搜索</code>等经典算法都可以利用栈的特性来实现. 由于本文的目的是讲解栈<code>react</code>中的使用场景, 所以与栈相关的经典案例本文不再列举, 请读者移步其他算法资料.</p><h2 id="react-当中的使用场景" tabindex="-1"><a class="header-anchor" href="#react-当中的使用场景" aria-hidden="true">#</a> React 当中的使用场景</h2><h3 id="context-状态管理-context" tabindex="-1"><a class="header-anchor" href="#context-状态管理-context" aria-hidden="true">#</a> Context 状态管理 {#context}</h3>`,10),_=s("code",null,"fiber",-1),y={href:"https://zh-hans.reactjs.org/docs/context.html#reactcreatecontext",target:"_blank",rel:"noopener noreferrer"},f=s("code",null,"Context api",-1),C=s("code",null,"Context.Provider",-1),w=s("code",null,"Class.contextType",-1),j=s("code",null,"Context.Consumer",-1),S=s("code",null,"api",-1),R=s("code",null,"react",-1),F=s("code",null,"栈",-1),L=s("code",null,"Context.Provider",-1),M=s("code",null,"Context.Consumer",-1),P=s("code",null,"stack",-1),T={href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberStack.old.js#L10-L71",target:"_blank",rel:"noopener noreferrer"},V=e(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> type StackCursor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">|</span> current<span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 维护一个全局stack</span>
<span class="token keyword">const</span> <span class="token literal-property property">valueStack</span><span class="token operator">:</span> Array<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">// 一个工厂函数, 创建StackCursor对象</span>
<span class="token keyword">function</span> createCursor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>defaultValue<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> StackCursor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">current</span><span class="token operator">:</span> defaultValue<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">return</span> index <span class="token operator">===</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 出栈</span>
<span class="token keyword">function</span> pop<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>cursor<span class="token operator">:</span> StackCursor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token literal-property property">fiber</span><span class="token operator">:</span> Fiber<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  cursor<span class="token punctuation">.</span>current <span class="token operator">=</span> valueStack<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>
  valueStack<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  index<span class="token operator">--</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 入栈</span>
<span class="token keyword">function</span> push<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>cursor<span class="token operator">:</span> StackCursor<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> <span class="token literal-property property">fiber</span><span class="token operator">:</span> Fiber<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  index<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token comment">// 注意: 这里存储的是 cursor当前值, 随后更新了cursor.current为</span>
  valueStack<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> cursor<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
  cursor<span class="token punctuation">.</span>current <span class="token operator">=</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在<code>ReactFiberStack.js</code>源码中, 定义的<code>valueStack</code>作为全局变量, 用来存储所有的<code>StackCursor.current</code>(不仅仅存储<code>context api</code>相关的<code>StackCursor</code>, 在<code>context 原理</code>章节中详细解读, 本节只讨论与<code>context api</code>相关的栈操作).</p>`,2),A=s("code",null,"StackCursor",-1),E=s("code",null,"context api",-1),W=s("code",null,"StackCursor",-1),N={href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberNewContext.old.js#L38",target:"_blank",rel:"noopener noreferrer"},B=s("code",null,"ReactFiberNewContext.js",-1),U=e(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token comment">// 定义全局 valueCursor, 用于管理&lt;Context.Provider/&gt;组件的value</span>
<span class="token keyword">const</span> <span class="token literal-property property">valueCursor</span><span class="token operator">:</span> StackCursor<span class="token operator">&lt;</span>mixed<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">createCursor</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ...省略无关代码</span>

<span class="token comment">// 将context当前的值保存到valueCursor中, 并设置context._currentValue为最新值</span>
<span class="token comment">// 运行完成之后context为最新状态</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> pushProvider<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>providerFiber<span class="token operator">:</span> Fiber<span class="token punctuation">,</span> <span class="token literal-property property">nextValue</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token literal-property property">context</span><span class="token operator">:</span> ReactContext<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">=</span> providerFiber<span class="token punctuation">.</span>type<span class="token punctuation">.</span>_context<span class="token punctuation">;</span>
  <span class="token function">push</span><span class="token punctuation">(</span>valueCursor<span class="token punctuation">,</span> context<span class="token punctuation">.</span>_currentValue<span class="token punctuation">,</span> providerFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  context<span class="token punctuation">.</span>_currentValue <span class="token operator">=</span> nextValue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 取出valueCursor中保存的旧值, 设置到context._currentValue上.</span>
<span class="token comment">// 运行完成之后context恢复到上一个状态</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">popProvider</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">providerFiber</span><span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> currentValue <span class="token operator">=</span> valueCursor<span class="token punctuation">.</span>current<span class="token punctuation">;</span>
  <span class="token function">pop</span><span class="token punctuation">(</span>valueCursor<span class="token punctuation">,</span> providerFiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token literal-property property">context</span><span class="token operator">:</span> ReactContext<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">=</span> providerFiber<span class="token punctuation">.</span>type<span class="token punctuation">.</span>_context<span class="token punctuation">;</span>
  context<span class="token punctuation">.</span>_currentValue <span class="token operator">=</span> currentValue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>假设有如下组件结构(平时开发很难有这样的代码, 此处完全是为了演示<code>context api</code>中涉及到的栈操作):</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">const</span> MyContext <span class="token operator">=</span> React<span class="token punctuation">.</span><span class="token function">createContext</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token comment">// 第一级</span>
    <span class="token operator">&lt;</span>MyContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>MyContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">value1</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
          <span class="token comment">//第二级嵌套</span>
          <span class="token operator">&lt;</span>MyContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>MyContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
              <span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">value2</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
                <span class="token comment">// 第三级嵌套</span>
                <span class="token operator">&lt;</span>MyContext<span class="token punctuation">.</span>Provider value<span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span>MyContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
                    <span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">value3</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>
                      <span class="token operator">&lt;</span>span<span class="token operator">&gt;</span>
                        <span class="token punctuation">{</span>value1<span class="token punctuation">}</span><span class="token operator">-</span><span class="token punctuation">{</span>value2<span class="token punctuation">}</span><span class="token operator">-</span><span class="token punctuation">{</span>value3<span class="token punctuation">}</span>
                      <span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
                    <span class="token punctuation">)</span><span class="token punctuation">}</span>
                  <span class="token operator">&lt;</span><span class="token operator">/</span>MyContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>MyContext<span class="token punctuation">.</span>Provider<span class="token operator">&gt;</span>
              <span class="token punctuation">)</span><span class="token punctuation">}</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>MyContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
          <span class="token operator">&lt;</span><span class="token operator">/</span>MyContext<span class="token punctuation">.</span>Provider<span class="token operator">&gt;</span>
        <span class="token punctuation">)</span><span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>MyContext<span class="token punctuation">.</span>Consumer<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>MyContext<span class="token punctuation">.</span>Provider<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,3),I=s("code",null,"codesandbox",-1),K={href:"https://codesandbox.io/s/inspiring-wildflower-lkpom?file=/src/App.js",target:"_blank",rel:"noopener noreferrer"},O=e('<p>将<code>fiber</code>树构造过程中<code>MyContext</code>对象在栈中的变化情况表示出来:</p><ol><li><p><code>beginWork</code>阶段: 入栈</p><ul><li><code>reconciler</code>之前, 由于<code>const MyContext = React.createContext(0);</code>已经创建了<code>MyContext</code>对象, 所以其初始值是<code>0</code>.</li><li><code>reconciler</code>过程中, 每当遇到<code>Context.Provider</code>类型的节点, 则会执行<code>pushProvider</code>.</li></ul></li></ol><p><img src="'+r+'" alt=""></p><ol start="2"><li><code>completeWork</code>阶段: 出栈 <ul><li><code>reconciler</code>过程中, 每当遇到<code>Context.Provider</code>类型的节点, 则会执行<code>popProvider</code>.</li><li><code>reconciler</code>之后, <code>valueStack</code>和<code>valueCursor</code>以及<code>MyContext</code>都恢复到了初始状态.</li></ul></li></ol><p><img src="'+k+'" alt=""></p><p>注意:</p><ul><li>本节只分析<code>context</code>实现源码中与<code>栈</code>相关的部分, 所以只涉及到了<code>Context.Provider</code>(供应者)节点.</li><li>对于<code>Context.Consumer</code>(消费者)以及更新阶段<code>context</code>的运行机制的深入解读放在<code>context原理</code>章节中.</li></ul><h3 id="executioncontext-执行上下文" tabindex="-1"><a class="header-anchor" href="#executioncontext-执行上下文" aria-hidden="true">#</a> executionContext 执行上下文</h3>',8),z=s("code",null,"executionContext",-1),q=s("code",null,"ReactFiberWorkLoop.js",-1),D={href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L247-L256",target:"_blank",rel:"noopener noreferrer"},G=s("p",null,[n("表面上看"),s("code",null,"executionContext"),n("和栈并没有直接关系, 但实际在改变"),s("code",null,"executionContext"),n("的时候, 巧妙的利用了"),s("code",null,"函数调用栈"),n(", 实现"),s("code",null,"executionContext"),n("状态的维护.")],-1),H=s("code",null,"executionContext",-1),J=s("code",null,"函数调用栈",-1),Q={href:"https://github.com/facebook/react/blob/v17.0.2/packages/react-reconciler/src/ReactFiberWorkLoop.old.js#L1117-L1207",target:"_blank",rel:"noopener noreferrer"},X=s("code",null,"batchedUpdates",-1),Y=s("code",null,"unbatchedUpdates",-1),Z=e(`<div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> batchedUpdates<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">R</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">R</span><span class="token punctuation">,</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token constant">A</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">R</span> <span class="token punctuation">{</span>
  <span class="token comment">// 在执行回调之前, 先改变 executionContext</span>
  <span class="token keyword">const</span> prevExecutionContext <span class="token operator">=</span> executionContext<span class="token punctuation">;</span>
  executionContext <span class="token operator">|=</span> BatchedContext<span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    <span class="token comment">// 回调执行完毕之后, 再恢复到以前的值 prevExecutionContext</span>
    executionContext <span class="token operator">=</span> prevExecutionContext<span class="token punctuation">;</span>
    <span class="token comment">// ... 省略无关代码</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> unbatchedUpdates<span class="token operator">&lt;</span><span class="token constant">A</span><span class="token punctuation">,</span> <span class="token constant">R</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token constant">A</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">R</span><span class="token punctuation">,</span> <span class="token literal-property property">a</span><span class="token operator">:</span> <span class="token constant">A</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">R</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> prevExecutionContext <span class="token operator">=</span> executionContext<span class="token punctuation">;</span>
  executionContext <span class="token operator">&amp;=</span> <span class="token operator">~</span>BatchedContext<span class="token punctuation">;</span>
  executionContext <span class="token operator">|=</span> LegacyUnbatchedContext<span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    executionContext <span class="token operator">=</span> prevExecutionContext<span class="token punctuation">;</span>
    <span class="token comment">// ... 省略无关代码</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// ... 省略其他函数</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这些函数的共性:</p><ol><li>执行回调之前, 先保存当前值为<code>prevExecutionContext</code>, 再改变 <code>executionContext</code>.</li><li>在执行回调<code>fn</code>期间, 无论函数<code>fn</code>调用栈有多深, 被改变过的<code>executionContext</code>始终有效.</li><li>回调执行完毕之后, 恢复到以前的值 <code>prevExecutionContext</code>.</li></ol><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结" aria-hidden="true">#</a> 总结</h2><p>本节主要介绍了<code>栈</code>在<code>react</code>源码中的使用情况. 涉及入栈出栈等基本操作(<code>Context</code> 状态管理), 以及对函数调用栈的巧妙运用(改变<code>executionContext</code>执行上下文).</p><p>由于<code>reconciler</code>过程是一个深度优先遍历过程, 对于<code>fiber树</code>来讲, 向下探寻(<code>beginWork</code>阶段)和向上回溯(<code>completeWork</code>阶段)天然就和栈的入栈(<code>push</code>)和出栈(<code>pop</code>)能够无缝配合(context 机制就是在这个特性上建立起来的).</p><h2 id="参考资料" tabindex="-1"><a class="header-anchor" href="#参考资料" aria-hidden="true">#</a> 参考资料</h2>`,7),$={href:"https://blog.csdn.net/K346K346/article/details/80849966",target:"_blank",rel:"noopener noreferrer"};function nn(sn,an){const o=p("RouterLink"),t=p("ExternalLinkIcon");return i(),u("div",null,[v,s("ul",null,[m,s("li",null,[n("常说的"),b,n("有 2 种指代, 一种是"),h,n("中的堆(在"),a(o,{to:"/notes/reactAlgorithm/heapsort.html"},{default:c(()=>[n("React 算法之堆排序")]),_:1}),n("中有介绍), 另一种是"),x,n("中的堆(本系列不做介绍, 读者可自行了解).")])]),g,s("p",null,[n("在"),_,n("树创建过程中, 如果使用了"),s("a",y,[f,a(t)]),n("(具体来说是使用"),C,n(", "),w,n(", "),j,n("等"),S,n("), "),R,n("内部会维护一个"),F,n("来保存提供者("),L,n(")的状态, 供给消费者("),M,n(")使用.")]),s("p",null,[n("首先看"),P,n("的定义("),s("a",T,[n("ReactFiberStack.js"),a(t)]),n("中):")]),V,s("p",null,[n("注意"),A,n("是一个泛型对象, 与"),E,n("相关的"),W,n("定义在"),s("a",N,[B,a(t)]),n(":")]),U,s("p",null,[n("可在"),I,n("中查看"),s("a",K,[n("运行结果"),a(t)]),n(".")]),O,s("p",null,[z,n("是在"),q,n("中定义的一个"),s("a",D,[n("全局变量(相对于该闭包)"),a(t)]),n(", 且定义成二进制变量, 通过位运算来维护其状态(在"),a(o,{to:"/notes/reactAlgorithm/bitfield.html"},{default:c(()=>[n("React 算法之位运算")]),_:1}),n("一文中已有介绍).")]),G,s("p",null,[n("本节主要是体现"),H,n("和"),J,n("之间的配合运用("),s("a",Q,[n("具体源码"),a(t)]),n("), 这里以"),X,n("和"),Y,n("为例进行分析.")]),Z,s("ul",null,[s("li",null,[s("a",$,[n("栈"),a(t)])])])])}const en=l(d,[["render",nn],["__file","06.html.vue"]]);export{en as default};
